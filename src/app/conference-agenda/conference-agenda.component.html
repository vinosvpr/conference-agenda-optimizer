<div class="agenda-container" role="main" aria-labelledby="agendaTitle">
  <h1 id="agendaTitle">ðŸŽ¯ Conference Agenda Optimizer</h1>
  <div class="agenda-container-main">
    <!-- Filters -->
    <div class="filters" role="region" aria-label="Filter Options">
      <div class="track" aria-label="Filter sessions by track">
        <select (change)="filterTrack.set($any($event.target).value)">
          <option value="">All Tracks</option>
          <option *ngFor="let t of getUniqueTracks()">{{ t }}</option>
        </select>
      </div>
      <div class="search" aria-label="Search title or speaker">
        <input
          type="text"
          placeholder="Search title or speaker"
          aria-label="Search by title or speaker"
          (input)="searchTerm.set($any($event.target).value)"
        />
      </div>

      <div class="track">
        <label for="sortField">Sort by:</label>
        <select
          id="sortField"
          (change)="sortField.set($any($event.target).value)"
          [value]="sortField()"
        >
          <option value="start">Start Time</option>
          <option value="priority">Priority</option>
        </select>
      </div>
    </div>
    <p class="filter-count" role="status" aria-live="polite">
      <ng-container *ngIf="filteredCount() > 0; else noMatches">
        {{ filteredCount() }} session{{ filteredCount() > 1 ? "'s" : "" }} match
        your filter
      </ng-container>
      <ng-template #noMatches>No sessions match your filter</ng-template>
    </p>
    <!-- Session List -->
    <div class="session-list" role="region" aria-label="Session List">
      <cdk-virtual-scroll-viewport itemSize="50" class="viewport">
        <table
          class="session-table"
          role="table"
          aria-describedby="filterResults"
        >
          <thead>
            <tr role="row">
              <th role="columnheader">Select</th>
              <!-- <th role="columnheader">â˜…</th> -->
              <th role="columnheader">Title</th>
              <th role="columnheader">Speaker</th>
              <th role="columnheader">Room</th>
              <th
                role="columnheader"
                (click)="setSort('start')"
                class="sortable"
                [class.active]="sortField() === 'start'"
              >
                Start
                <span *ngIf="sortField() === 'start'">
                  {{ sortDirection() === "asc" ? "â–²" : "â–¼" }}
                </span>
              </th>
              <th role="columnheader">End</th>
              <th
                role="columnheader"
                (click)="setSort('priority')"
                class="sortable"
                [class.active]="sortField() === 'priority'"
              >
                Priority
                <span *ngIf="sortField() === 'priority'">
                  {{ sortDirection() === "asc" ? "â–²" : "â–¼" }}
                </span>
              </th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngIf="filteredSessions().length > 0; else noResults">
              <tr
                *cdkVirtualFor="let s of filteredSessions(); trackBy: trackById"
                role="row"
              >
                <td role="cell">
                  <input
                    type="checkbox"
                    [checked]="s.selected"
                    (change)="agenda.toggleSelect(s)"
                    [attr.aria-label]="'Select session ' + s.title"
                  />
                </td>

                <td
                  role="cell"
                  class="session-title-cell cursor-pointer"
                  (mouseenter)="hoveredSession = s.id"
                  (mouseleave)="hoveredSession = null"
                >
                  <!-- Normal state -->
                  <span *ngIf="hoveredSession !== s.id && !s.mustInclude">
                    {{ s.title }}
                  </span>

                  <!-- Hover or Must Include -->
                  <span
                    *ngIf="hoveredSession === s.id || s.mustInclude"
                    class="must-include-span"
                    [class.active]="s.mustInclude"
                    (click)="agenda.toggleMustInclude(s)"
                  >
                    <ng-container *ngIf="s.mustInclude; else mustText">
                      <span class="star active">â˜…</span> {{ s.title }}
                    </ng-container>
                    <ng-template #mustText>â˜… Must Include</ng-template>
                  </span>
                </td>
                <td role="cell">
                  {{ s.speaker }}
                </td>
                <td role="cell">
                  {{ s.room }}
                </td>
                <td role="cell">
                  {{ s.start }}
                </td>
                <td role="cell">
                  {{ s.end }}
                </td>
                <td role="cell">
                  {{ s.priority }}
                </td>
              </tr>
            </ng-container>
            <ng-template #noResults>
              <tr>
                <td colspan="7" class="no-results">No results found</td>
              </tr>
            </ng-template>
          </tbody>
        </table>
      </cdk-virtual-scroll-viewport>
    </div>
  </div>
  <button
    (click)="generateOptimizedAgenda()"
    aria-label="Generate optimized agenda based on selected sessions"
  >
    Generate My Optimized Agenda
  </button>

  <!-- Optimized Results -->
  <div
    class="optimized-results"
    *ngIf="optimizedSessions().length"
    role="region"
    aria-label="Optimized Agenda Results"
  >
    <h3 role="heading" aria-level="2">Optimized Agenda</h3>
    <p role="status" aria-live="polite">
      Optimized from {{ filteredSessions().length }} sessions â†’
      {{ optimizedSessions().length }} selected (Total Priority:
      {{ totalPriority() }})
    </p>
    <ul role="list">
      <li
        *ngFor="let s of optimizedSessions()"
        role="listitem"
        [attr.title]="!s.mustInclude ? s.tooltip : ''"
      >
        {{ s.title }} - {{ s.speaker }} - {{ s.room }} - {{ s.start }} to
        {{ s.end }}
      </li>
    </ul>
  </div>
</div>
